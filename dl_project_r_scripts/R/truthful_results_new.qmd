---
title: "/usr/bin/time comparison of fastp thread changes"
execute:
  echo: false
  eval: true
format: html
editor:
  markdown:
    wrap: 80
---
```{r}
#load libraries
library(tidyverse)
library(ggpubr)
library(patchwork)
library(dplyr)
library(ggrepel)
library(ggpattern)
library(patchwork)
```

```{r}
# load files
filenames <- list.files("../../../dl_project_files/results_TruthfulQA/", recursive = TRUE, full.names = TRUE, pattern = '.csv$')

filenames


filenames_truth <- list.files("../../../dl_project_files/results_TruthfulQA_fulltruth/", recursive = TRUE, full.names = TRUE, pattern = '.csv$')

filenames_truth
```



```{r}
process_file <- function(file_path, truthful = FALSE) {
  if (truthful) {
      `Merged models` <- str_match(file_path, "TruthfulQA_fulltruth\\/(?:results)_([^_]+)-fulltruth_ZeroShot_TruthfulQA_EN.csv")[2]
      data <- read.csv(file_path)
      data <- data |>
      mutate(`Merged models` = `Merged models`)
  } else {
      `Merged models` <- str_match(file_path, "TruthfulQA\\/(?:results)_([^_]+)_ZeroShot_TruthfulQA_EN.csv")[2]
      data <- read.csv(file_path)
      data <- data |>
      mutate(`Merged models` = `Merged models`)
  }
  return(data)
}


result_list <- lapply(filenames, process_file)
result_list_truth <- lapply(filenames_truth, process_file, truthful = TRUE)

result_list
result_list_truth
```


```{r}
combined_data <- bind_rows(result_list, .id = "source") |>
  filter(category != "Statistics") |>
  rename(`Merged models` = `Merged models`) |>
  mutate(truthful = "QA prompt") |>
  select(question_id, `Merged models`, category, correct_letter, best_prediction, truthful)

combined_data_truth <- bind_rows(result_list_truth, .id = "source") |>
  filter(category != "Statistics") |>
  rename(`Merged models` = `Merged models`) |>
  mutate(truthful = "Truthful prompt") |>
  select(question_id,  `Merged models`, category, correct_letter, best_prediction, truthful)

combined_data_merge <- bind_rows(combined_data, combined_data_truth)
```

```{r}
filenames_instruct <- combined_data_merge |>
  select(`Merged models`) |>
  unique() |>
  filter(str_detect(`Merged models`, "biomistral-instruct-")) |>
  pull()

filenames_instruct_02 <- combined_data_merge |>
  select(`Merged models`) |>
  unique() |>
  filter(str_detect(`Merged models`, "biomistral-instruct02")) |>
  pull()

filenames_internist <- combined_data_merge |>
  select(`Merged models`) |>
  unique() |>
  filter(str_detect(`Merged models`, "internistai-biomistral")) |>
  pull()

filenames_single <- combined_data_merge |>
  select(`Merged models`) |>
  unique() |>
  filter(str_detect(`Merged models`, "BioMistral-7B-Instruct") |
           str_detect(`Merged models`, "internistai-7b") |
           str_detect(`Merged models`, "Mistral-7B")) |>
  pull()

filenames_instruct
filenames_instruct_02
filenames_internist
filenames_single
```


```{r}
# SINGLE PLOT
combined_data_merge |> group_by(truthful)

create_plot_combined <- function(data_name, data_tibble, title_text, subtitle_text) {

  plot_obj <- data_tibble |>
      mutate(correct = ifelse(correct_letter == best_prediction, 1, 0)) |>
      filter(`Merged models` %in% data_name) |>
      mutate(correct_percent = correct*100) |>
      ggbarplot(x = "category", y = "correct_percent", fill = "Merged models", alpha = 0.4, facet.by = "truthful",
              x.text.angle = 35,
              lab.vjust = -0.25,
              height = 0.5,
              xlab = "Category",
              ylab = "Truthfulness",
              lab.nb.digits = 1,
              palette = "Set1",
              position = position_dodge(0.85),
              add = c("mean"),
              label = FALSE, lab.size = 2.5) |>
        facet(facet.by = "truthful") +
    theme(axis.text.x = element_text(size = 8)) +
    theme(legend.text = element_text(size = 5), 
          legend.title = element_text(size = 6), 
          legend.key.size = unit(0.1, 'inches'),
          legend.position = "right",
          plot.margin = unit(c(0, 0, 0, 0), 
                                "inches")) +
  guides(fill = guide_legend(nrow = 6)) +
    plot_annotation(title = title_text,
                           subtitle = subtitle_text)  &
      theme(plot.subtitle = element_text(size = 10)) + labs_pubr() + grids(linetype = "dashed")
  
    return(plot_obj)

}

```

```{r}
# Not truthful data
internist_merge_plot <- create_plot_combined(data_name = filenames_internist,
                     data_tibble = combined_data_merge,
                     title_text = "",
                     subtitle_text = "")
internist_merge_plot


instruct_merge_plot <- create_plot_combined(data_name =  filenames_instruct,
                     data_tibble = combined_data_merge,
                     title_text = "",
                     subtitle_text = "")
instruct_merge_plot

instruct02_merge_plot <- create_plot_combined(data_name =  filenames_instruct_02,
                     data_tibble = combined_data_merge,
                     title_text = "",
                     subtitle_text = "")
instruct02_merge_plot


single_model_plot <- create_plot_combined(data_name = filenames_single,
                     data_tibble = combined_data_merge,
                     title_text = "",
                     subtitle_text = "")
single_model_plot
```


```{r}
dir.create("../plots")
# ggsave(paste("single_model_plot_new", ".eps"), plot = single_model_plot, device = cairo_ps, path = "../plots")
ggsave(paste("instruct_merge_plot_new", ".eps"), plot = instruct_merge_plot, device = cairo_ps, path = "../plots")
ggsave(paste("internist_merge_plot_new", ".eps"), plot = internist_merge_plot, device = cairo_ps, path = "../plots")
ggsave(paste("instruct02_merge_plot_new", ".eps"), plot = instruct02_merge_plot, device = cairo_ps, path = "../plots")

```

```{r}
combined_data_merge |>
      mutate(correct = ifelse(correct_letter == best_prediction, 1, 0)) |>
      filter(truthful == "QA prompt")
```

